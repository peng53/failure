<html>
<style>
body {
	font-family: monospace;
	font-size: 1.2em;
	margin: 0;
	background: #eee;
	color: #000;
}
details {
}
.nobullet {
}
summary {
		list-style: none;
		font-weight: 600;
}
summary {
	color: #000;
}
summary:hover {
	color: red;

}
.key {
	font-weight: 600;
}
textarea {
	outline: none;
}
textarea.left {
	color: #4b0018;
	background-color: #ecd9df;
}
textarea.right {
	color: #244c00;
	background-color: #b1c89c;
}
.diff::after {

}
.diff {
}
.left.val {
	background: #ecd9df;
}
.right.val {
	background: #b1c89c;
}
.left.t_undefined, .left.t_null {
	color: #e297af;
}
.left.t_boolean {
	color: #bd5e7c;
}
.left.t_string {
	color: #711331;
}
.left.t_number {
	color: #4b0018;
}
.left.t_object, .left.t_array {
	color: #973252;
}
/*right*/
.right.t_undefined, .right.t_null {
	color: #bce498;
}
.right.t_boolean {
	color: #8cbe5f;
}
.right.t_string {
	color: #407213;
}
.right.t_number {
	color: #244c00;
}
.right.t_object, .right.t_array {
	color: #639833;
}


#output {
	max-width: 90vw;
	overflow-wrap: break-word;
}
.highlight {
	border-right: 4px double red;
	background: pink;
}
.highlight_sub {
	border-left: 1.5px dotted teal;
}
#container {
	display: grid;
	grid-template:
		"a a" max-content
		"b c";

	width: 100vw;
	height: 100vh;
	grid-template-columns: max-content 1fr;
}
#textareas {
	grid-area: a;
	display: grid;
	grid-template-columns: 1fr 1fr;
	resize: vertical;
	overflow: auto;
	border-bottom: 2px solid #ccc;
	min-height: 2em;
	max-height: 90vh;
}
#textareas textarea {
	width: 100%;
	border: 0;
	resize: none;
}
#output {
	grid-area: c;
	overflow: auto;
	padding: 1em;
}
#diffs {
	grid-area: b;
	background: #ddd;
	overflow: auto;
	resize: horizontal;
	border-right: 2px solid #ccc;
	min-width: 50px;
	max-width: calc(100vw - 2em);
	padding: 1em;
}
.val {
	text-decoration: none;
}
.val:hover {
	text-decoration: underline;
}
#diffs a {
	color: #462b2b;
}
.chosen,.discard {
	background: none !important;
	cursor: text;
}
.discard, .discard:hover {
	text-decoration: line-through;
}
</style>
<script>
'use strict';
// json tree
var diff_arr = [];
var diff_link = [];
var leftjson = undefined;
var rightjson = undefined;
var outjson = undefined;
var diff_data  = [];

function jtype(v){
	let t = typeof v;
	if (t=='object'){
		if (v == null){
			return 'null';
		} else if (Array.isArray(v)){
			return 'array';
		} else {
			return 'object';
		}
	}
	return t;
}

function openDetails(d){
	switch (d.tagName){
		case 'BODY':
			return;
			break;
		case 'DETAILS':
			d.open = true;
			d.classList.add('highlight_sub');
		default:
			openDetails(d.parentElement);
			break;
	}
}

function diff_scroll(ele){
	const n = parseInt(ele.target.name);
	diff_arr[n].scrollIntoView();
	Array.from(document.querySelectorAll('.highlight')).forEach(h=>h.classList.remove('highlight'));
	Array.from(document.querySelectorAll('.highlight_sub')).forEach(h=>h.classList.remove('highlight_sub'));
	diff_arr[n].classList.add('highlight');
	ele.target.classList.add('highlight');
	openDetails(diff_arr[n].parentElement);
}

function diff_scroll_n(n){
	diff_arr[n].scrollIntoView();
	Array.from(document.querySelectorAll('.highlight')).forEach(h=>h.classList.remove('highlight'));
	Array.from(document.querySelectorAll('.highlight_sub')).forEach(h=>h.classList.remove('highlight_sub'));
	diff_arr[n].classList.add('highlight');
	diff_link[n].classList.add('highlight');
	//ele.target.classList.add('highlight');
	openDetails(diff_arr[n].parentElement);
}
function chooseDiff(n,side){
	const change = diff_data[n];
	if (diff_arr[n].querySelector('chosen')){
		return;
	}
	switch (side){
		case 'left':
			diff_arr[n].querySelector('.left').classList.add('chosen');
			diff_arr[n].querySelector('.right').classList.add('discard');
			change.par[change.key] = change.lv;
			break;
		case 'right':
			diff_arr[n].querySelector('.left').classList.add('discard');
			diff_arr[n].querySelector('.right').classList.add('chosen');
			change.par[change.key] = change.rv;
			break;
		default:
			// this should never happen!
			break;
	}
}

function renderTree(jtext,rtext, output,diffs){
	leftjson = JSON.parse(jtext.value);
	rightjson = JSON.parse(rtext.value);
	outjson = JSON.parse(rtext.value);
	const j = leftjson;
	const r = rightjson;
	let item,ltype,rtype,snode,key,val,dlink;
	let diff_count = diff_arr.length;
	const allkeys = new Set();
	const onode = document.createElement('ul');
	const stk = [{key:'Json', node:onode, json:j, rson: r, out: outjson, akey:null}];
	let par;
	while (stk.length>0){
		item = stk.pop();
		snode = undefined;
		ltype = jtype(item.json);
		rtype = jtype(item.rson);
		if (ltype!=rtype){ // deep rendering is stopped when types don't match
			ltype = 'string';
		}
		switch (ltype){
			case 'object':
				snode = item.node.appendChild(document.createElement('li'));
				snode.classList.add('nobullet');
				snode = snode.appendChild(document.createElement('details'));
				snode.open = true;
				snode.appendChild(document.createElement('summary')).textContent = item.key+'{}';
				snode = snode.appendChild(document.createElement('ul'));
				for (const k of Object.keys(item.json)){
					//stk.push({key:k, node:snode, json:item.json[k], rson: item.rson[k]});
					//if (item.rson.hasOwnProperty(k)){
						allkeys.add(k);
					//}
				}
				for (const k of Object.keys(item.rson)){
					//stk.push({key:k, node:snode, json:item.json[k], rson: item.rson[k]});
					//if (item.json.hasOwnProperty(k)){
						allkeys.add(k);
					//}
				}
				par = (item.akey) ? item.out[item.akey] : item.out;
				for (const k of Array.from(allkeys).reverse()){
					stk.push({key:k, node:snode, json:item.json[k], rson: item.rson[k], out: par, akey:k});
				}
				allkeys.clear();
				break;
			case 'array':
				snode = item.node.appendChild(document.createElement('li'));
				snode.classList.add('nobullet');
				snode = snode.appendChild(document.createElement('details'));
				snode.open = true;
				snode.appendChild(document.createElement('summary')).textContent = `${item.key}[${(item.json.length==item.rson.length) ? item.json.length : item.json.length+' or '+item.rson.length}]`;
				snode = snode.appendChild(document.createElement('ol'));
				snode.start = 0;
				par = (item.akey) ? item.out[item.akey] : item.out;
				for (let m=Math.max(item.json.length,item.rson.length)-1;m>=0;--m){
					stk.push({key:'', node:snode, json:item.json[m], rson:item.rson[m], out: par, akey:m});
				}
				break;
			default:
				snode = item.node.appendChild(document.createElement('li'));
				if (item.key.length>0){
					//snode.textContent = `${item.key} : ${JSON.stringify(item.json)}`;
					key = snode.appendChild(document.createElement('span'));
					key.classList.add('key');
					key.textContent = item.key;
					snode.appendChild(document.createTextNode(': '));
				} else {
					//snode.textContent = JSON.stringify(item.json);
				}
				//combinedvalue = ?  : `${JSON.stringify(item.json)} | ${JSON.stringify(item.rson)}`;
				if (item.json==item.rson){
					val = snode.appendChild(document.createElement('span'));
					val.textContent = JSON.stringify(item.json);
					val.classList.add('val','t_'+ltype);
					
				} else {
					snode.classList.add('diff');
					val = snode.appendChild(document.createElement('a'));
					val.href= `javascript:(chooseDiff(${diff_count},'left'));`;
					val.classList.add('val','left','t_'+jtype(item.json));
					val.textContent = (item.json!=undefined) ? JSON.stringify(item.json,null,'\t') : 'undefined';
					snode.appendChild(document.createTextNode(' â‰  '));
					val = snode.appendChild(document.createElement('a'));
					val.href= `javascript:(chooseDiff(${diff_count},'right'));`;
					val.classList.add('val','right','t_'+jtype(item.rson));
					val.textContent = (item.rson!=undefined) ? JSON.stringify(item.rson,null,'\t') : 'undefined';
					dlink = diffs.appendChild(document.createElement('li'));
					dlink = dlink.appendChild(document.createElement('a'));
					//dlink.onclick = diff_scroll;
					dlink.name = diff_count;
					dlink.href = `javascript:(diff_scroll_n(${diff_count}));`;
					dlink.textContent = `${++diff_count} `;
					//diffs.appendChild(document.createElement('br'));
					diff_link.push(dlink);
					diff_arr.push(snode);
					diff_data.push({par: item.out, key: item.akey, lv: item.json, rv: item.rson});
				}
				//snode.appendChild(document.createTextNode(combinedvalue));
				//item.node.appendChild(document.createElement('br'));
				break;
		}
	}
	output.appendChild(onode);
}

</script>
<div id='container'>
<div id='textareas'>
<textarea id='lefttext' class='left'>
{
"a": 1,
"b": "two",
"c": [3],
"d": {
	"e": [4,53],
	"j": 512
	},
"k": null
}
</textarea><textarea id='righttext' class='right'>{
"a": 2,
"b": "twu",
"c": [3],
"d": {
	"e": [4,56,57],
	"j": 123,
	"i": "eye"
	},
"f": "hi",
"k": {
	"vacation": "beach"
	}
}
</textarea>
</div>

<div id='output'>
<button onclick='renderTree(lefttext,righttext,output,diffs)'>Render</button>
</div>
<div id='diffs'></div>
</div>
</html>
