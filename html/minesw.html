<html>
<head>
<style>
	#mines {
		position: absolute;
		top: 0;
		bottom: 0;
		left: 0;
		right: 0;
		margin: auto;
		border: 1px solid black;
	}
</style>
</head>
<body>
<canvas
	id='mines'
	width='400px'
	height='400px'
	data-cellsize=20
	data-nmines=10
></canvas>
<br /><button onclick='clearField()'>Clear</button>
<br /><button onclick='revealField()'>RevealAll</button>
</body>
<script src='queue.js'></script>
<script>
	'use strict';
	/* primative internals */
	function Mines2d(cols, rows, cellSize){
		this.A = RectArray(rows,cols, 0);
		this.visible = RectArray(rows,cols, false);
		this.cols = cols;
		this.rows = rows;
		this.cellSize = cellSize;

		this.plantMine = function(r,c){
			this.A[r][c] = 9;
			let notTop = r>0, notLeft = c>0, notRight = c<this.cols, notBottom = r+1<this.rows;
			if (notTop){
				this.plantWarning(r-1,c);
				if (notLeft) this.plantWarning(r-1,c-1);
				if (notRight) this.plantWarning(r-1,c+1);
			}
			if (notBottom){
				this.plantWarning(r+1,c);
				if (notLeft) this.plantWarning(r+1,c-1);
				if (notRight) this.plantWarning(r+1,c+1);
			}
			if (notLeft) this.plantWarning(r,c-1);
			if (notRight) this.plantWarning(r,c+1);
		};

		this.plantWarning = function(r,c){
			if (this.A[r][c] !== 9){
				++this.A[r][c];
			}
		};
	}
	
	function RectArray(rows, cols, v){
		let a = new Array(rows);
		for (let r = 0; r<rows; ++r){
			a[r] = ArrayWithValue(cols,v);
		}
		return a;
	}
	
	function ArrayWithValue(size, val){
		let a = new Array(size);
		for (let i=0;i<size;++i){
			a[i]=val;
		}
		return a;
	}
	

</script>

<script>
	'use strict';
	/* data setup */
	// Durstenfeld' shuffle
	function shuffleArray(A){
		let j,tempValue;
		for (let i=A.length-1; i>0; --i){
			j = Math.floor(Math.random()*i);
			tempValue = A[j];
			A[j] = A[i];
			A[i] = tempValue;
		}
	}
	function setupMinefield(cols, rows, mineCt, cellSize){
		let mineLocLen = cols*rows;
		if (mineLocLen <= mineCt){
			alert('# of mines is equal or greater than dimensions');
			return;
		}
		let mineLoc = new Array(mineLocLen);
		// mineLoc is an Array of mine's priority
		for (let i=0; i<mineLoc.length; ++i){
			mineLoc[i] = i;
		}
		shuffleArray(mineLoc);
		let mfield = new Mines2d(cols, rows, cellSize);
		let r, c;
		for (let i=0; i<mineCt; ++i){
			r = Math.floor(mineLoc[i] / cols);
			c = mineLoc[i] % cols;
			mfield.plantMine(r,c);
		}
		
		return mfield;
	}
</script>

<script>
	'use strict';
	/* drawing */
	function drawTileLines(width,height,mcell,color){
		ctx.strokeStyle = color;
		for (let x=mcell; x<width; x+=mcell){
			ctx.moveTo(x,0);
			ctx.lineTo(x,height);
		}
		for (let y=mcell; y<height; y+=mcell){
			ctx.moveTo(0,y);
			ctx.lineTo(width,y);
		}
		ctx.stroke();
	}
	function revealNumber(row, col, mfield){
		if (!mfield.visible[row][col]){
			let t = mfield.A[row][col];
			let x = mfield.cellSize * col;
			let y = mfield.cellSize * row;
			ctx.fillStyle = mineNumberColors[t];
			if (t == 9){
				t = 'M';
			}
			let offset = mfield.cellSize/2;
			ctx.fillText(t, x+offset, y+offset, mfield.cellSize);
			mfield.visible[row][col] = true;
		}
	}
	/* ui interaction */
	function floodReveal(r,c,mfield,cellSize,cellOff){
		// needs same args as the function(s) it calls..
		revealNumber(r,c,myfield,cellSize,cellOff);
		//floodFill(myfield,r,c,0);
		fill2(myfield, r, c, mcell, moff);
	}
	function getCursorPosition(canvas, event) {
		const rect = canvas.getBoundingClientRect();
		const x = event.clientX - rect.left;
		const y = event.clientY - rect.top;
		if (window.event.ctrlKey){
			XYtoCRcall(x,y, function(c, r){
				myfield.plantMine(r,c);
			});
		} else {
			XYtoCRcall(x,y, function(c, r){
				touchCanvas(r,c)
			});
		}
	}
	function XYtoCRcall(x,y,f){
		let c = Math.floor(x/myfield.cellSize);
		let r = Math.floor(y/myfield.cellSize);
		if (c < myfield.cols && r < myfield.rows){
			f(c,r);
		}
	}
	function touchCanvas(r,c){
		if (myfield.A[r][c] == 0){
			floodReveal(r,c,myfield,mcell,moff);
		} else if (myfield.A[r][c] == 'c'){
		} else {
			revealNumber(r,c,myfield,mcell,moff);
		}
	}
	function clearField(){
		ctx.clearRect(0,0,can.width,can.height);
		myfield.A = RectArray(myfield.rows,myfield.cols, 0);
		myfield.visible = RectArray(myfield.rows,myfield.cols, false);
		drawTileLines(mwidth,mheight,mcell,'green');
	}
	function revealField(){
		for (let r=0;r<myfield.rows;++r){
			for (let c=0;c<myfield.cols;++c){
				revealNumber(r,c,myfield,mcell,moff);
			}
		}
	}
</script>

<script>
	'use strict';
	
	var ANALYZEARRAY = [];
	
	const can = document.getElementById('mines');
	const ctx = can.getContext('2d');

	const mcell = Number(can.dataset.cellsize); // size of graphical cell in pixels
	const mwidth = can.width-(can.width%mcell);
	const mheight = can.height-(can.height%mcell);
	
	const moff = mcell/2; // offset to center of cell
	const mcount = Number(can.dataset.nmines);
	const mineNumberColors = ['#bbb','#aaa','#999','#888','#777','#666','#444','#333','#111','#000'];
	let myfield = setupMinefield(mwidth/mcell, mheight/mcell, mcount, mcell);
	can.addEventListener('mousedown', function(e) {
		getCursorPosition(can, e);
	});

	ctx.font = mcell.toString()+'px monospace';
	ctx.textAlign = 'center';
	ctx.textBaseline = 'middle';

	drawTileLines(mwidth,mheight,mcell,'green');
	
	revealField();
	//*/

</script>

</html>