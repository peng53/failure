<html>
<style>
#formout, #formout input, #rawjson, #propname, #eprops input {
	width: 100%;
}
input,textarea {
	border: 1px gray outset;
}
#rawjson {
	resize: vertical;
}
#tprops td, #eprops td {
	font-weight: bold;
	background: #ccc;
	text-align: justify;
	font-variant: small-caps;
}
h3, body {
	margin: 0;
}
#sidebar {
	position: fixed;
	float: left;
	width: 200px;
	margin: 0;
	overflow: auto;
	height: 100%;
}
#content {
	margin: 0;
	margin-left: 200px;
	text-align: center;
}
.sbrow {
	margin-bottom: 1em;
	text-align: center;
}
#content h3 {
	background: beige;
}
#sidebar h3 {
	background: lime;
}
#entries, #inputsTable {
	border-collapse: collapse;
	width: 100%;

}
#entries tr:nth-child(even){
	background: #eee;
}
</style>
<script>
'use strict';
class DynaForm {
	constructor(out, entryF){
		this.out = out;
		this.entryF = entryF;
	}
	addprop(name){
		this.entryF(this.out,name);
	}
	getitem(table){
		const item = {};
		const inputs = this.out.getElementsByTagName('input');
		table.cols.forEach(
			(v,k) => item[k] = inputs[v].value
		);
		return item;
	}
}
class DataTable {
	constructor(table){
		this.table = table;
		this.cols = new Map();
	}
	prop(name){
		return (this.cols.has(name) ? this.cols.get(name) : -1);
	}
	addCol(name){
		if (this.cols.has(name)){
			return -1;
		}
		const n = this.cols.size;
		this.cols.set(name, n);
		document.getElementById('tprops').insertCell(-1).appendChild(document.createTextNode(name));
		return n;
	}
	addRow(item){
		const row = this.table.insertRow(-1);
		this.cols.forEach(
			(v,k) => row.insertCell(-1).appendChild(
				document.createTextNode(
					(k in item) ? item[k] : ''
				)
			)
		);
	}
}
function exportItems(items){
	const link = document.createElement('a');
	link.href = 'data:attachment/text,' + encodeURI(JSON.stringify(items));
	link.target = '_blank';
	link.download = 'out.json';
	link.click();
}
function importItems(text, to, form, table){
	if (text.length < 1){
		alert('0-len JSON data input');
		return;
	}
	const data = JSON.parse(text);
	for (const item of data){
		for (const key in item){
			if (table.prop(key) == -1){
				form.addprop(key);
				table.addCol(key);
			}
		}
		table.addRow(item);
		to.push(item);
	}
}
function addprop(name){
	if (name.length==0){
		alert('Property name too short!');
		return;
	}
	if (mytable.prop(name) !== -1){
		alert('Property already exists!');
		return;
	}
	myform.addprop(name);
	mytable.addCol(name);
}
function additem(form, table, to){
	const item = form.getitem(table);
	table.addRow(item);
	to.push(item);
}
function deleteItems(data, table){
	const msg = prompt("Delete which rows?");
	if (!msg || msg.length<1) return;
	const rows = msg.split(',');
	let i,j;
	for (const index of rows){
		if (index.search('-') !== -1){
			[i,j] = index.split('-', 2);
			if (i<j && j<data.length){
				data.splice(i,j-i+1);
			}
			
		}
	}
}
function createPropSidebarEntry(sidebar, label){
	const div = document.createElement('div');
	const lab = document.createElement('span');
	lab.textContent = label;
	div.appendChild(lab);
	div.appendChild(document.createElement('br'));
	div.appendChild(document.createElement('input'));
	sidebar.appendChild(div);
}
function createPropTableEntry(proprow, label){
	const cell = proprow.insertCell(-1);
	cell.appendChild(document.createElement('input'));
}
</script>

<div id='sidebar'>

<div class='sbrow'>
<h3>Add a field..</h3>
<input id='propname' /><br />
<button onclick='addprop(propname.value)'>New</button>
</div>

<div class='sbrow'>
<h3>Import JSON..</h3>
<textarea id='rawjson'></textarea>
<button onclick='importItems(rawjson.value, jsonOut, myform, mytable);'>Import</button>
</div>

</div>

<div id='content'>
<h3>Entries</h3>
<table id='entries'>
<thead>
<tr id='tprops'></tr>
</thead>
</table>
<table id='inputsTable'>
<tr id='eprops'></tr>
</table>
<button onclick='additem(myform,mytable,jsonOut)'>Add</button>
<button onclick='exportItems(jsonOut)'>Export All</button>
</div>

<script>
'use strict';
const jsonOut = [];
const mytable = new DataTable(entries);
const myform = new DynaForm(eprops, createPropTableEntry);
</script>
</html>