<html>
	<head>
	<style>
	table {
		width: 100%;
		height: 100%;
		border-collapse: collapse;
	}
	td,th {
		border: 1px #000 solid;
		font-size: 5vmin;
	}
	td {
		text-align: center;
	}
	.titlecell {
		background: #888;
	}
	th {
		background: lightblue;
	}
	table[contenteditable="true"] {
		background: beige;
	}
	</style>
	<script>
		function fakeParams(){
			let q = location.href.split('?');
			let kv, d = {};
			if (q.length>1){
				q = q[1].split('&');
				for (let i=0,l=q.length;i<l;++i){
					if (q[i].search('=')!=-1){
						kv = q[i].split('=');
						d[kv[0]] = kv[1];
					} else {
						d[q[i]]=true;
					}
				}
			}
			return {data: d, get: function(k){ return this.data[k];}};
		}

		function reconfigThead(title, cols){
			const thead = document.querySelector('thead');
			const tcell = thead.insertRow(-1).appendChild(document.createElement('th'));
			tcell.colSpan = cols.length;
			tcell.classList.add('titlecell');
			tcell.textContent = title;
			const colnameRow = thead.insertRow(-1);
			for (let col in cols){
				colnameRow.appendChild(document.createElement('th')).textContent = cols[col];
			}
		}
		function setTbody(rows){
			// Setting data from alldata
			const tbody = document.querySelector('tbody');
			let row;
			for (let r=0,l=rows.length;r<l;++r){
				row = tbody.insertRow(-1);
				for (let c=0;c<cols.length;++c){
					row.insertCell(-1).textContent = rows[r][c];
				}
			}
		}
		function pageData(){
			const colNames = Array.from(document.querySelectorAll('th:not(.titlecell)')).map(function(x){return x.textContent;});
			const rowData = Array.from(document.querySelectorAll('tbody tr')).
				map(function(r){
					return Array.from(r.querySelectorAll('td')).
						map(function(x){return x.textContent;});
				});
			return {cols:colNames, data:rowData, title:document.querySelector('.titlecell').textContent};
		}
		function exportBlob(){
			const blob=new Blob([JSON.stringify(pageData())], {type:'text/json'});
			window.open(URL.createObjectURL(blob));
		}
		function page2qs(){
			const data = pageData();
			const rows = data.data.map(function(r){return r.join('|');});
			const parts = ['title='+data.title, 'datasep=row', 'cols='+data.cols.join(':'), 'rows='+rows.join(':')];
			prompt('Query string is:', '?'+parts.join('&'));
		}

		function tableAddCol(){
			document.querySelector('.titlecell').colSpan += 1;
			document.querySelectorAll('thead tr')[1].appendChild(document.createElement('th'));
			const rows = document.querySelectorAll('tbody tr');
			for (let r=0,l=rows.length;r<l;++r){
				rows[r].insertCell(-1);
			}
		}
		function tableAddRow(){
			const cols = document.querySelectorAll('th:not(.titlecell)').length;
			const row = document.querySelector('tbody').insertRow(-1);
			for (let i=0;i<cols;++i){
				row.insertCell(-1);
			}
			row.contentEditable = 'true';
			row.contentEditable = 'inherit';
		}
	</script>
	</head>
	<body>
		<table><thead></thead><tbody></tbody></table>
		<div style='position:fixed;bottom:0;left:50%;background:#fff'>
		<a href="javascript:location='?title=test&cols=x:2x plus 1&x=1:2:3:4&2x plus 1=3:5:7&datasep=col'">ColSep</a>
		<a href="javascript:location='?title=rowSep&cols=letter:ascii&rows=a|97:b|98:c|99&datasep=row'">RowSep</a>
		</div>
	</body>
	<script>
		let params;
		try {
			params = (new URL(document.location)).searchParams;
		} catch(e) {
			// IE support
			params = fakeParams();
		}

		const cols = params.get('cols').split(':');
		const title = params.get('title');
		document.head.appendChild(document.createElement('title')).textContent = title;
		reconfigThead(title,cols);

		const datasep = params.get('datasep');
		let rows = [];

		if (datasep == 'col'){
			// Getting data from query
			let coldata;
			for (let col in cols){
				coldata = params.get(cols[col]).split(':');
				for (let r=0;r<coldata.length;++r){
					if (r>=rows.length){
						rows.push([]);
					}
					rows[r].push(coldata[r]);
				}
			}
		} else if (datasep == 'row'){
			let rawRows = params.get('rows').split(':');
			for (let row in rawRows){
				rows.push(rawRows[row].split('|'));
			}
		}
		setTbody(rows);

		addEventListener('keydown', function(e){
			if (e.ctrlKey){
				if (e.key=='e'){
					e.preventDefault();
					const t = document.querySelector('table');
					t.contentEditable = (t.contentEditable=='true') ? 'false' : 'true';
				} else if (e.key=='\\'){
					e.preventDefault();
					tableAddCol();
				} else if (e.key==';'){
					e.preventDefault();
					tableAddRow();
				} else if (e.key=='s'){
					e.preventDefault();
					exportBlob();
				}
			}
		});
	</script>
</html>
