<html>
	<head>
	<style>
	table {
		width: 100%;
		height: 100%;
		border-collapse: collapse;
	}
	td,th {
		border: 1px #000 solid;
		font-size: 5vmin;
	}
	td {
		text-align: center;
	}
	#titlecell {
		background: #888;
	}
	th {
		background: lightblue;
	}
	table[contenteditable="true"] {
		background: beige;
	}
	.hidden {
		display: none;
	}
	</style>
	<script>
		'use strict';
		function fakeParams(){
			const q = location.href.split('?'), d = {};
			if (q.length>1){
				q[1].split('&').forEach(function(a){
					const kv = a.split('=');
					d[kv[0]] = (kv.length == 1) ? true : kv[1];
				});
			}
			return {data: d, get: function(k){ return this.data[k];}};
		}

		function addTh(text){
			titlecell.colSpan += 1;
			header.appendChild(document.createElement('th')).textContent = text;
		}
		function tableAddCol(text){
			addTh(text);
			Array.from(document.querySelectorAll('tbody tr')).forEach(function(r){r.insertCell(-1);});
		}
		function reconfigThead(title, cols){
			cols.forEach(function(c){addTh(c);});
			titlecell.textContent = title;
			titlecell.colSpan = cols.length;
		}
		function addTr(colVals){
			const row = document.querySelector('tbody').insertRow(-1);
			colVals.forEach(function(c){row.insertCell(-1).textContent = c;});
		}
		function nullStringArr(cnt){
			const arr = [];
			for (let i=0;i<cnt;++i) arr.push('');
			return arr;
		}
		function tableAddRow(){
			addTr(nullStringArr(document.querySelectorAll('#header th').length));
		}
		function setTbody(rows){
			rows.forEach(function(r){addTr(r);});
		}

		function ArrayFrum(xs){
			let r = [];
			for (let i=0,l=xs.length;i<l;++i){
				r.push(xs[i]);
			}
			return r;
		}
		function pageData(){
			const colNames = Array.from(document.querySelectorAll('#header th')).map(function(x){return x.textContent;});
			const rowData = Array.from(document.querySelectorAll('tbody tr')).
				map(function(r){
					return Array.from(r.querySelectorAll('td')).
						map(function(x){return x.textContent;});
				});
			return {cols:colNames, data:rowData, title:titlecell.textContent};
		}
		function exportBlob(){
			const blob=new Blob([JSON.stringify(pageData())], {type:'text/json'});
			window.open(URL.createObjectURL(blob));
		}
		function page2qs(){
			const data = pageData();
			const rows = data.data.map(function(r){return r.join('|');});
			const parts = ['title='+data.title, 'datasep=row', 'cols='+data.cols.join(':'), 'rows='+rows.join(':')];
			prompt('Query string is:', '?'+parts.join('&'));
		}
		function rowsSeparatedByCol(cols){
			const rows = [];
			for (let c=0,l=cols.length;c<l;++c){
				for (let r=0;r<cols[c].length;++r){
					if (r>=rows.length){
						rows.push([]);
					}
					rows[r].push(cols[c][r]);
				}
			}
			return rows;
		}
	</script>
	</head>
	<body>
		<table><thead><tr><th id='titlecell'></th></tr><tr id='header'></tr></thead><tbody></tbody></table>
		<div style='position:fixed;bottom:0;left:50%;background:#fff'>
		<a href="javascript:location='?title=test&cols=x:2x plus 1&x=1:2:3:4&2x plus 1=3:5:7&datasep=col'">ColSep</a>
		<a href="javascript:location='?title=rowSep&cols=letter:ascii&rows=a|97:b|98:c|99&datasep=row'">RowSep</a>
		</div>
	</body>
	<script>
		let params;
		try {
			params = (new URL(document.location)).searchParams;
		} catch(e) {
			// IE support
			params = fakeParams();
		}

		const cols = params.get('cols').split(':');
		const title = params.get('title');
		document.querySelector
		document.title = title;
		reconfigThead(title,cols);

		const datasep = params.get('datasep');
		let rows;
		if (datasep == 'col'){
			rows = rowsSeparatedByCol(cols.map(function(p){return params.get(p).split(':');}));
		} else if (datasep == 'row'){
			rows = params.get('rows').split(':').map(function(r){return r.split('|');});
		}
		setTbody(rows);


		function controlPanel(){
			let d = document.body.appendChild(document.createElement('div'));
			d.classList.add('controlpanel');
			let b = d.appendChild(document.createElement('button'));
			b.textContent = 'Add Column';
			b.onclick = function(){
				const text=prompt('Column name:');
				if (text && text.length>0) tableAddCol(text);
			};
			b = d.appendChild(document.createElement('button'));
			b.textContent = 'Add Row';
			b.onclick = function(){ tableAddRow(); };
			b = d.appendChild(document.createElement('button'));
			b.textContent = 'Save';
			b.onclick = function(){ exportBlob(); };
			b = d.appendChild(document.createElement('button'));
			b.textContent = 'Edit';
			b.onclick = function(){
				const t = document.querySelector('table');
				t.contentEditable = (t.contentEditable=='true') ? 'false' : 'true';
			};
			return d;
		}
		const cp = controlPanel();
		addEventListener('keydown', function(e){
			if (e.key=='Control'){
				cp.classList.toggle('hidden');
			}
		});
	</script>
	<style>
		.controlpanel {
			position: fixed;
			top:0;
		}
	</style>
</html>
