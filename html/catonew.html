<style>
.hiddencol {
	display: none;
}
#container {
	display: grid;
	grid-template-columns: 2fr 1fr;
	align-items: top;
	gap: 1em;
	height: calc(100vh - 2em);
}
#maintable {
	border: 1px solid black;
	border-collapse: collapse;
	width: 100%;
}
#maintable th {
	background: #ccc;
	text-align: left;
	font-family: monospace;
	padding: 2px;
}
#maintable td {
	padding: 2px;
}
#maintablediv {
	height: 100%;
	width: 100%;
}
#newRowDialog input, #newRowDialog select {
	width: 100%;
}
</style>

<!--
<button onclick='dialogLoadFile.show()'>Load Another File</button>
-->

<dialog id='dialogLoadFile'>
<h3>Import JSON..</h3>
<input type='file' accept='.json,.csv' id='dialogLoadFileInput' /><br /><br />
<button onclick='this.parentElement.close()'>Cancel</button>
</dialog>

<div id='container'>

<div id='maintablediv'>
<table id='maintable'>
<thead><tr></tr></thead>
<tbody></tbody>
</table>
</div>

<div id='newRowDialog'>
</div>

</div>
<script>
let input;
function gotJson(ev){
	// main table should be clear before this action
	console.log('got json');
	input = JSON.parse([ev.target.result]);
	let row = maintable.querySelector('thead tr');
	let cell;
	// need to store input.keys somewhere
	let form_ele;
	for (const k in input.keys){
		cell = row.appendChild(document.createElement('th'));
		cell.appendChild(document.createTextNode(k));
		if (input.keys[k].hidden){
			cell.classList.add('hiddencol');
		}
			newRowDialog.appendChild(document.createTextNode(k));
			newRowDialog.appendChild(document.createElement('br'));
			switch (input.keys[k].type){
				case 'text':
				case 'link':
				case 'img': 
					form_ele = document.createElement('input');
					break;

				case 'number':
					form_ele = document.createElement('input');
					form_ele.type = 'number';
					if (input.keys[k].hasOwnProperty('min')){
						form_ele.min = input.keys[k].min;
					}
					if (input.keys[k].hasOwnProperty('max')){
						form_ele.max = input.keys[k].max;
					}
					break;

				case 'date':
					form_ele = document.createElement('input');
					form_ele.type = 'date';
					break;

				case 'enum':
					form_ele = document.createElement('select');
					input.keys[k].values.forEach(
						e=>form_ele.appendChild(document.createElement('option')).textContent = e);
					break;

			}
			newRowDialog.appendChild(form_ele);
			newRowDialog.appendChild(document.createElement('br'));
	}
	let tbod = maintable.querySelector('tbody');

	for (const r of input.data){
		row = tbod.insertRow(-1);
		for (const k in input.keys){
			cell = row.insertCell(-1);
			cell.appendChild(document.createTextNode(r[k]));
			if (input.keys[k].hidden){
				cell.classList.add('hiddencol');
			}

		}
		//console.log(r);
	}
}
function gotCsv(ev){
	console.log('got csv');
	for (const line of ev.target.result.split('\n')){
		console.log(line);
	}
}

{
	// binding the file in dialog
	const fileSelected = function(e){
		if (e.target.files.length>0){
			const reader = new FileReader();
			const ext = e.target.files[0].name.split('.').pop();
			switch (ext){
				case 'csv':
					reader.addEventListener('load', gotCsv);
					break;
				case 'json':
					reader.addEventListener('load', gotJson);
					break;
				default:
					return;
					break;
			}
			
			reader.readAsText(e.target.files[0]);
			dialogLoadFile.close();
		}
	};
	dialogLoadFileInput.addEventListener('change', fileSelected);
}
dialogLoadFile.show();
newRowDialog.show();
</script>
