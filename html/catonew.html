<style>
.hiddencol {
	display: none;
}
#container {
	display: grid;
	grid-template-columns: 2fr 1fr;
	align-items: top;
	gap: 1em;
	height: calc(100vh - 2em);
}
#maintable {
	border: 1px solid black;
	border-collapse: collapse;
	width: 100%;
}
#maintable th {
	background: #ccc;
	text-align: left;
	font-family: monospace;
	padding: 2px;
}
#maintable td {
	padding: 2px;
}
#maintablediv {
	height: 100%;
	width: 100%;
}
#newRowDialog input, #newRowDialog select {
	width: 100%;
}
</style>

<!--
<button onclick='dialogLoadFile.show()'>Load Another File</button>
-->

<dialog id='dialogLoadFile'>
<h3>Import JSON..</h3>
<input type='file' accept='.json,.csv' id='dialogLoadFileInput' /><br /><br />
<button onclick='this.parentElement.close()'>Cancel</button>
</dialog>

<div id='container'>

<div id='maintablediv'>
<table id='maintable'>
<thead><tr></tr></thead>
<tbody></tbody>
</table>
</div>

<div id='newRowDialog'></div>

</div>
<script>
let input;
let maintablevar;
let dynfrm;
function addFormToTable(myform,mytable){
	mytable.addRow(myform.getitem());
}
function createEntrySet(props){
	let form_ele;
	switch (props.type){
		case 'number':
			form_ele = document.createElement('input');
			form_ele.type = 'number';
			if (props.hasOwnProperty('min')){
				form_ele.min = props.min;
			}
			if (props.hasOwnProperty('max')){
				form_ele.max = props.max;
			}
			break;
		case 'date':
			form_ele = document.createElement('input');
			form_ele.type = 'date';
			break;
		case 'enum':
			form_ele = document.createElement('select');
			props.values.forEach(
				e=>form_ele.appendChild(document.createElement('option')).textContent = e);
			break;
		case 'text':
		case 'link':
		case 'img':
		default:
			form_ele = document.createElement('input');
			break;
	}
	return form_ele;
}

function createFormSet(myform, label, props){
	const fs = myform.appendChild(document.createElement('fieldset'));
	fs.appendChild(document.createElement('legend')).textContent=label;
	const myentry = fs.appendChild(createEntrySet(props));
	return myentry;
}

class DynaForm {
	constructor(out, entryF, keys){
		this.out = out;
		this.entryF = entryF;
		this.keys = keys;
		this.eles = new Map();
	}
	addprop(name,props){
		this.eles.set(name, this.entryF(this.out,name,props));
	}
	getitem(){
		const item = {};
		this.eles.forEach(
			(v,k) => item[k] = v.value);
		return item;
	}
}

function htmlElement(value, props){
	const nv = value ?? '';
	let e;
	switch (props.type){
		case 'link':
			e = document.createElement('a');
			e.href = nv;
			e.textContent = value;
			break;
		case 'img':
			e = document.createElement('img');
			e.src = nv;
			e.alt = nv;
			e.height = props.height;
			e.width = props.width;
			break;
		case 'number':
		case 'enum':
		case 'date':
		case 'text':
		default:
			e = document.createTextNode(nv);
			break;
	}
	return e;
}

class DataTable {
	constructor(table,keys){
		this.table = table;
		this.cols = new Map();
		this.rowHeader = table.querySelector('thead').querySelector('tr');
		this.rowBody = table.querySelector('tbody');
		this.keys = keys;
	}
	prop(name){
		return (this.cols.has(name) ? this.cols.get(name) : -1);
	}
	addCol(name,hidden=false){
		if (this.cols.has(name)){
			return -1;
		}
		const n = this.cols.size;
		this.cols.set(name, n);
		const myth = this.rowHeader.appendChild(document.createElement('th'));
		myth.appendChild(document.createTextNode(name));
		if (hidden){
			myth.classList.add('hiddencol');
		}
		this.afterAddCol(hidden);
		return n;
	}
	afterAddCol(hidden=false){
		const rows = this.rowBody.children;
		let cell;
		for (const row of rows){
			cell = row.insertCell(-1)
			cell.appendChild(document.createTextNode(''));
			if (hidden){
				cell.classList.add('hiddencol');
			}
		}
	}
	addRow(item){
		const row = this.rowBody.insertRow(-1);
		this.cols.forEach(
			(v,k) => {
				let c =row.insertCell(-1);
				//
				//c.appendChild(document.createTextNode((k in item) ? item[k] : ''));
				//
				c.appendChild(htmlElement(item[k],this.keys[k]));
				if (this.keys[k].hidden){
					c.classList.add('hiddencol');
				}
		});
	}
}

function gotJson(ev){
	// main table should be clear before this action
	input = JSON.parse([ev.target.result]);
	maintablevar = new DataTable(maintable,input.keys);
	dynfrm = new DynaForm(newRowDialog,createFormSet, input.keys);
	for (const k in input.keys){
		maintablevar.addCol(k,input.keys[k].hidden);
		dynfrm.addprop(k,input.keys[k]);
	}
	newRowDialog.appendChild(document.createElement('br'));
	const addBtn = newRowDialog.appendChild(document.createElement('button'));
	addBtn.textContent = 'Add';
	addBtn.onclick = ()=>addFormToTable(dynfrm,maintablevar);
	for (const r of input.data){
		maintablevar.addRow(r);
	}
}
function gotCsv(ev){
	console.log('got csv');
	for (const line of ev.target.result.split('\n')){
		console.log(line);
	}
}

{
	// binding the file in dialog
	const fileSelected = function(e){
		if (e.target.files.length>0){
			const reader = new FileReader();
			const ext = e.target.files[0].name.split('.').pop();
			switch (ext){
				case 'csv':
					reader.addEventListener('load', gotCsv);
					break;
				case 'json':
					reader.addEventListener('load', gotJson);
					break;
				default:
					return;
					break;
			}
			
			reader.readAsText(e.target.files[0]);
			dialogLoadFile.close();
		}
	};
	dialogLoadFileInput.addEventListener('change', fileSelected);
}
dialogLoadFile.show();
</script>
